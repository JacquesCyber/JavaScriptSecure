name: ZAP Baseline Scan

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo
        ports:
          - 27017:27017
        options: --health-cmd "mongosh --eval 'db.stats()'" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ Install dependencies
      run: npm install

    - name: ğŸ” Create dummy SSL cert
      run: |
        openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=localhost"

    - name: ğŸš€ Start app
      run: |
        npm run dev &
        echo "Waiting for server..."
        sleep 10

    - name: ğŸ§ª Wait for /health endpoint
      run: |
        for i in {1..30}; do
          if curl -k --silent https://localhost:3000/health; then
            echo "Server is up!"
            break
          fi
          echo "Waiting..."
          sleep 2
        done

    - name: ğŸ›¡ï¸ Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'https://localhost:3000'
        cmd_options: '-config scanner.threadPerHost=5 -config scanner.attackOnStart=true -config api.disablekey=true'
        fail_action: false
        allow_issue_writing: true

    - name: ğŸ—‚ï¸ Copy report to workspace
      run: cp /zap/wrk/report_html.html ./report_html.html

    - name: ğŸ“ Upload ZAP report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report_html.html