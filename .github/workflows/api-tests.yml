name: API Security Tests

on:
  push:
    branches: [ main, develop, StartOfPart3 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  api-security-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Test Keys
        run: |
          mkdir -p keys
          openssl genrsa -out keys/private.pem 2048
          openssl rsa -in keys/private.pem -pubout -out keys/public.pem
          echo " Generated test RSA keys"
          
      - name: Start Application
        run: |
          rm -f .env
          NODE_ENV=test npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          echo " Waiting for application..."
          for i in {1..60}; do
            if curl -f http://localhost:3000/health >/dev/null 2>&1; then
              echo " Application ready!"
              break
            fi
            [ $i -eq 60 ] && echo " Timeout" && exit 1
            sleep 1
          done
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ENCRYPTION_IV: ${{ secrets.ENCRYPTION_IV }}
          NODE_ENV: test
          
      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra
      
      - name: Fix Postman Test - Add accountNumber to login test
        run: |
         
          node -e "
          const fs = require('fs');
          const testFile = './postman/banking-security-tests.json';
          const tests = JSON.parse(fs.readFileSync(testFile, 'utf8'));
          
          // Find and update the 'Test Rate Limiting on Login' test
          const authTests = tests.item.find(item => item.name === 'Authentication Tests');
          if (authTests) {
            const loginTest = authTests.item.find(item => item.name === 'Test Rate Limiting on Login');
            if (loginTest && loginTest.request && loginTest.request.body) {
              loginTest.request.body.raw = '{\n  \"username\": \"attacker\",\n  \"accountNumber\": \"1234567890\",\n  \"password\": \"wrongpassword\"\n}';
              fs.writeFileSync(testFile, JSON.stringify(tests, null, 2));
              console.log(' Updated login test with accountNumber');
            }
          }
          "
        
      - name: Run API Security Tests
        run: |
          newman run postman/banking-security-tests.json \
            --environment postman/test-environment.json \
            --reporters cli,json \
            --reporter-json-export newman-results.json \
            --bail \
            --timeout-request 10000
        continue-on-error: false
        
      - name: Display Test Results
        if: always()
        run: |
          echo " API Security Test Results:"
          if [ -f newman-results.json ]; then
            node -e "
              const results = require('./newman-results.json');
              const stats = results.run.stats;
              console.log(' Tests Passed:', stats.assertions.passed);
              console.log(' Tests Failed:', stats.assertions.failed);
              console.log(' Total Assertions:', stats.assertions.total);
              console.log('  Total Requests:', stats.requests.total);
            "
          fi
          
      - name: Check Test Results
        if: always()
        run: |
          if [ -f newman-results.json ]; then
            FAILED=$(node -e "console.log(require('./newman-results.json').run.stats.assertions.failed)")
            if [ "$FAILED" != "0" ]; then
              echo " $FAILED test(s) failed!"
              exit 1
            fi
            echo " All API security tests passed!"
          fi
          
      - name: Cleanup
        if: always()
        run: |
          [ ! -z "$APP_PID" ] && kill $APP_PID || true
          echo " Cleanup complete"
