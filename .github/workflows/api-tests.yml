name: API Security Tests

on:
  push:
    branches: [ main, develop, StartOfPart3 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  api-security-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Test Keys
        run: |
          mkdir -p keys
          openssl genrsa -out keys/private.pem 2048
          openssl rsa -in keys/private.pem -pubout -out keys/public.pem
          echo "‚úÖ Generated test RSA keys"
          
      - name: Start Application
        run: |
          rm -f .env
          NODE_ENV=test npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          echo "‚è≥ Waiting for application..."
          for i in {1..60}; do
            if curl -f http://localhost:3000/health >/dev/null 2>&1; then
              echo "‚úÖ Application ready!"
              break
            fi
            [ $i -eq 60 ] && echo "‚ùå Timeout" && exit 1
            sleep 1
          done
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ENCRYPTION_IV: ${{ secrets.ENCRYPTION_IV }}
          NODE_ENV: test
          
      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra
        
      - name: Run API Security Tests
        run: |
          newman run postman/banking-security-tests.json \
            --environment postman/test-environment.json \
            --reporters cli,json \
            --reporter-json-export newman-results.json \
            --bail \
            --timeout-request 10000
        continue-on-error: false
        
      - name: Display Test Results
        if: always()
        run: |
          echo "üìä API Security Test Results:"
          if [ -f newman-results.json ]; then
            node -e "
              const results = require('./newman-results.json');
              const stats = results.run.stats;
              console.log('‚úÖ Tests Passed:', stats.assertions.passed);
              console.log('‚ùå Tests Failed:', stats.assertions.failed);
              console.log('üìù Total Assertions:', stats.assertions.total);
              console.log('‚è±Ô∏è  Total Requests:', stats.requests.total);
            "
          fi
          
      - name: Check Test Results
        if: always()
        run: |
          if [ -f newman-results.json ]; then
            FAILED=$(node -e "console.log(require('./newman-results.json').run.stats.assertions.failed)")
            if [ "$FAILED" != "0" ]; then
              echo "‚ùå $FAILED test(s) failed!"
              exit 1
            fi
            echo "‚úÖ All API security tests passed!"
          fi
          
      - name: Cleanup
        if: always()
        run: |
          [ ! -z "$APP_PID" ] && kill $APP_PID || true
          echo "‚úÖ Cleanup complete"
